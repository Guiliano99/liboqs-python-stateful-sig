name: "Generate & Cache XMSS Keys"

on:
  push:
    branches: [ "**" ]
  workflow_dispatch:
  repository_dispatch: {}

env:
  KEY_GEN_VERSION: 1
  KEY_DIR: data/xmss_xmssmt_keys

jobs:
  build-cache:
    runs-on: ubuntu-latest
    timeout-minutes: 480  # 4 hours
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: pip install .[dev]

      - name: Restore existing cache (optional)
        id: cache-restore
        uses: actions/cache/restore@v4
        with:
          path: ${{ env.KEY_DIR }}
          key: xmss-v${{ env.KEY_GEN_VERSION }}

      - name: Show tree of cache directory
        run: |
          echo "Listing cache directory:"
          ls -R data/xmss_xmssmt_keys

      - name: Generate keys when missing
        run: |
          mkdir -p "${KEY_DIR}"
          python - <<'PY'
          from pathlib import Path
          import os
          import oqs, oqs.serialize
          out_dir = Path(os.environ["KEY_DIR"])
          out_dir.mkdir(parents=True, exist_ok=True)
          
          # Get list of all keys that need to be generated
          all_keys = [
              name for name in oqs.get_enabled_stateful_sig_mechanisms()
              if name.startswith(("XMSS-", "XMSSMT-"))
          ]
          
          # Check which keys already exist
          existing_keys = set()
          for key_file in out_dir.glob("*.der"):
              existing_keys.add(key_file.stem)
          
          # Generate only missing keys
          generated = 0
          skipped = 0
          for name in all_keys:
              key_filename = name.replace('/', '_layers_', 1).lower()
              key_path = out_dir / f"{key_filename}.der"

              if key_path.exists():
                  print(f"✓ Skipping {name} (already exists)")
                  skipped += 1
                  continue

              print(f"⚙ Generating {name}...")
              with oqs.StatefulSignature(name) as sig:
                  pub = sig.generate_keypair()
                  oqs.serialize.serialize_stateful_signature_key(sig, pub, key_path)
              print(f"✓ Generated {name}")
              generated += 1
          
          print(f"\n=== Summary ===")
          print(f"Generated: {generated}")
          print(f"Skipped: {skipped}")
          total = len(all_keys)
          print(f"Total: {total}")

          missing = []
          for name in all_keys:
              key_filename = name.replace('/', '_layers_', 1).lower()
              key_path = out_dir / f"{key_filename}.der"
              if not key_path.exists():
                  missing.append(name)

          if missing:
              print("\nERROR: The following keys could not be generated:")
              for name in missing:
                  print(f" - {name}")
              raise SystemExit(
                  f"Failed to generate {len(missing)} of {total} XMSS/XMSSMT keys"
              )

          print(f"\nAll {total} XMSS/XMSSMT keys are available in {KEY_DIR}.")
          print(f"\nFiles in {KEY_DIR}:")
          PY
          ls -lah "${KEY_DIR}"

      - name: Save cache (even on timeout/cancellation)
        if: always() && steps.cache-restore.outputs.cache-hit != 'true'
        uses: actions/cache/save@v4
        with:
          path: ${{ env.KEY_DIR }}
          key: xmss-v${{ env.KEY_GEN_VERSION }}
          enableCrossOsArchive: true


