name: "Generate & Cache XMSS Keys"

on:
  push:
    branches: [ "**" ]
  workflow_dispatch:
  repository_dispatch: {}

env:
  KEY_GEN_VERSION: 1
  KEY_DIR: data/xmss_xmssmt_keys

jobs:
  build-cache:
    runs-on: ubuntu-latest
    timeout-minutes: 480 # 8 hours
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: pip install .[dev]

      - name: Restore existing cache (optional)
        id: cache-restore
        uses: actions/cache/restore@v4
        with:
          path: ${{ env.KEY_DIR }}
          key: xmss-v${{ env.KEY_GEN_VERSION }}

      - name: Show tree of cache directory
        run: |
          echo "Listing cache directory:"
          ls -R data/xmss_xmssmt_keys

      - name: Generate keys when missing
        run: |
          mkdir -p "${KEY_DIR}"
          python scripts/pipeline_gen_stfl_keys.py "${KEY_DIR}"
          ls -lah "${KEY_DIR}"

      - name: Save cache (even on timeout/cancellation)
        if: always()
        uses: actions/cache/save@v4
        with:
          path: ${{ env.KEY_DIR }}
          key: xmss-v${{ env.KEY_GEN_VERSION }}
          enableCrossOsArchive: true
